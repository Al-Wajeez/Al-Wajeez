let fname = document.getElementById("first-name");
let lname = document.getElementById("last-name");
let ayear = document.getElementById("academic-year");
let rate = document.getElementById("rate");
let sname = document.getElementById("school-name");
let level = document.getElementById("level");
let section = document.getElementById("section");
let certificate = document.getElementById("certificate");
let signature = document.getElementById("signature");
let form = document.getElementById("form");
let container = document.querySelector(".certificate_content");

let generate = document.getElementById("Generate");
generate.addEventListener("click", (e) => {

      if (form.checkValidity()) {
        form.classList.add('was-validated'); // Trigger Bootstrap's form validation

        //e.preventDefault(); // Prevent the default form submission behavior

  let s_fname = fname.value;
  let s_lname = lname.value;
  let s_ayear = ayear.value;
  let s_rate = rate.value;
  let s_sname = sname.value;
  let s_level = level.value;
  let s_section = section.value;
  let s_certificate = certificate.value;
  let s_signature = signature.value;

  //form.style.display = "none";
  //certificate_content.style.backgroundColor = "white";

  //Random Digits
  a = 1; //Min value
  b = 9; //Max Value
  let rand = a + (b - 1) * Math.random(); //Main Formula
  let rand2 = Math.round(rand);
  c = 1; //Min value
  d = 9; //Max Value
  let rand3 = c + (d - 1) * Math.random(); //Main Formula
  let rand4 = Math.round(rand3);

  let certificate_content = document.getElementById("certificate-content");
  certificate_content.style.display = "block";
  certificate_content.innerHTML = `<div class="outer">
                            <div class="light-br">
                                <div class="dark-br">
                                    <div class="main-content">
                                        <div class="right-content">
                                            <div class="congrats">
                                                <img id="ism" src="assets/images/certificate/ism_allah.png" alt="">
                                                <h3><strong>${s_sname}</strong></h3>
                                            </div>
                                            <div class="course-name">
                                                <img id="ctitle" src="assets/images/certificate/c_top.png" alt="">
                                                <h1><strong>${s_certificate}</strong></h1>
                                                <img id="ctitle" src="assets/images/certificate/c_bottom.png" alt="">
                                            </div>
                                            <div class="para">
                                                <h4>تتشرف <strong>${s_sname}</strong> بتكريم التلميذ المتميز <strong>${s_fname} ${s_lname}</strong> للعام الدراسي <strong>${s_ayear}</strong>. حيث تحصل على معدل إستثنائي البالغ <strong>${s_rate}</strong>، وقد تميز بأدائه اللافت وجهوده المثمرة خلال مسيرته الدراسية.</h4>
                                                <h4>تم تكريمه في إطار تفوقه في السنة <strong>${s_level}</strong> بقسم <strong>${s_section}</strong>، حيث برزت موهبته واجتهاده في تحقيق النجاح والتميز.</h4>
                                                <h4>نهنئ التلميذ <strong>${s_fname} ${s_lname}</strong> على هذا الإنجاز الرائع، متمنين له دوام التفوق والنجاح في مسيرته الدراسية والمهنية.</h4>
                                            </div>
                                            <div class="authority">
                                                <div class="part-1">
                                                    <h3>سلمت بتاريخ: [تاريخ التسليم]</h3>
                                                </div>
                                                <div class="vl"></div>
                                                <div class="part-2">
                                                    <h3><strong>إمضاء ${s_signature}</strong></h3>
                                                </div>
                                            </div>
                                             <div class="certificate-id">Al Wajeez Certificate Id: AU${rand4}IZ${rand2}a${rand2}rPeUmO_IE${rand4}R${rand4}0L${rand4}ac${rand2}sN</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
    
    applyBackgroundImage(); // Call the function to apply the background image change

  }
});

// Reapply the background image selection
function applyBackgroundImage() {
    let selectedBackground = document.getElementById("background-select").value;
    let certificateContent = document.getElementById("certificate-content");

    switch (selectedBackground) {
        case '1':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_01.png')";
            break;
        case '2':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_02.png')";
            break;
        case '3':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_03.png')";
            break;
        case '4':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_04.png')";
            break;
        case '5':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_05.png')";
            break;
        case '6':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_06.png')";
            break;
        case '7':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_07.png')";
            break;
        case '8':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_08.png')";
            break;
        case '9':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_09.png')";
            break;
        case '10':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_10.png')";
            break;
        case '11':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_11.png')";
            break;
        case '12':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_12.png')";
            break;
        case '13':
            certificateContent.style.backgroundImage = "url('assets/images/certificate/border_13.png')";
            break;
    }
}

document.getElementById("background-select").addEventListener("change", applyBackgroundImage);

//document.addEventListener('contextmenu', function(event) {
//    event.preventDefault();
//});

// Download as JPG
let downloadJPG = document.getElementById("download");
downloadJPG.addEventListener("click", () => {
  let certif = document.getElementById('certificate-content');

  html2canvas(certif, {
    scale: 2, // Higher scale for better resolution
    useCORS: true // Helps with images hosted on other domains, if any
    logging: true, // Enable logging for debugging
    foreignObjectRendering: true, // Enable foreign object rendering for better text support
    letterRendering: 1, // Better text rendering
    allowTaint: true, // Allow tainting for CORS images
    async: false, // Synchronous rendering to ensure image is available immediately
    onclone: (doc) => {
      // Embed font in the cloned document
      let style = doc.createElement('style');
      style.innerHTML = `@import url("https://fonts.googleapis.com/css2?family=Cairo:wght@200..1000&family=Noto+Kufi+Arabic:wght@100..900&display=swap");

      body {
        font-family: 'Cairo', sans-serif;
      }`;
      doc.body.appendChild(style);
    }
  }).then(canvas => {
    // Convert the canvas to a data URL and trigger download
    let imageURL = canvas.toDataURL("image/jpeg", 0.98); // Convert canvas to JPEG format with quality
    let link = document.createElement('a');
    link.href = imageURL;
    link.download ='Al-wajeez-certificate.jpg';
    link.click();
  }).catch(err => {
    console.error("Error generating image:", err);
  });
});